<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.webmanifest">
    <title>ISW 영어 듣고 말하기</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; }
        body { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,0.98); border-radius: 24px; padding: 35px; box-shadow: 0 25px 70px rgba(0,0,0,0.25); }
        h1 { text-align: center; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; font-size: 2.2rem; font-weight: 800; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 0.9rem; font-weight: 500; }

        .update-banner { display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 20px; border-radius: 12px; margin-bottom: 15px; text-align: center; cursor: pointer; font-weight: 600; animation: pulse 2s infinite; }
        .update-banner:hover { opacity: 0.9; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }

        .settings-toggle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px; text-align: center; cursor: pointer; margin-bottom: 12px; font-weight: 600; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(102,126,234,0.3); transition: all 0.3s; }
        .settings-toggle:hover { transform: translateY(-2px); }
        .settings-grid { display: none; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .settings-grid.show { display: grid; }
        .setting-card { background: #f8fafc; padding: 15px; border-radius: 12px; border: 2px solid #e2e8f0; }
        .setting-card h3 { font-size: 0.9rem; color: #475569; margin-bottom: 10px; text-align: center; font-weight: 600; }
        .setting-card select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; }
        .setting-card .info-text { margin-top: 8px; font-size: 0.75rem; color: #64748b; text-align: center; }

        .current-sentence { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 35px 25px; border-radius: 18px; margin-bottom: 18px; text-align: center; box-shadow: 0 10px 30px rgba(79,70,229,0.3); }
        .sentence-english { font-size: 2rem; font-weight: 700; margin-bottom: 18px; word-wrap: break-word; line-height: 1.4; }
        .sentence-pronunciation { font-size: 1.25rem; opacity: 0.93; margin-bottom: 14px; word-wrap: break-word; font-weight: 500; line-height: 1.5; }
        .sentence-korean { font-size: 1.15rem; opacity: 0.9; word-wrap: break-word; font-weight: 600; line-height: 1.5; }

        .info-panel { background: linear-gradient(135deg, #f0f9ff 0%, #fae8ff 100%); padding: 18px 22px; border-radius: 16px; margin-bottom: 22px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; border: 1px solid rgba(79,70,229,0.1); }
        .info-item { text-align: center; }
        .info-label { font-size: 0.75rem; color: #7c3aed; font-weight: 600; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 1.15rem; color: #1e293b; font-weight: 700; }

        .status { text-align: center; padding: 12px; background: #d1fae5; border-radius: 10px; margin-bottom: 15px; font-weight: 600; color: #065f46; font-size: 0.9rem; }
        .status.loading { background: #fef3c7; color: #92400e; }
        .status.error { background: #fee2e2; color: #991b1b; }

        .voice-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; text-align: center; color: white; margin-bottom: 15px; }
        .voice-info .label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
        .voice-info .accent { font-size: 1.4rem; font-weight: bold; }
        .voice-info .note { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; }

        .timer-progress { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .timer { font-size: 2.5rem; font-weight: bold; color: #667eea; min-width: 150px; text-align: center; }
        .progress-bar { flex: 1; height: 30px; background: #e2e8f0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85rem; }

        .controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        button { padding: 13px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.25s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-start { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-pause { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-next { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .btn-prev { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .btn-reset { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        button:hover:not(:disabled) { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .version-info { text-align: center; margin-top: 10px; font-size: 0.75rem; color: #94a3b8; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 18px; border-radius: 15px; }
            h1 { font-size: 1.6rem; }
            .subtitle { font-size: 0.8rem; margin-bottom: 15px; }
            .settings-grid { grid-template-columns: 1fr; gap: 10px; }
            .info-panel { grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
            .current-sentence { padding: 25px 18px; }
            .sentence-english { font-size: 1.5rem; margin-bottom: 15px; }
            .sentence-pronunciation { font-size: 1.05rem; }
            .sentence-korean { font-size: 0.95rem; }
            .timer-progress { flex-direction: column; gap: 10px; }
            .timer { font-size: 2rem; min-width: auto; }
            .progress-bar { width: 100%; }
            .controls { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            button { padding: 11px; font-size: 13px; }
        }
        @media (max-width: 480px) {
            .container { padding: 15px; }
            h1 { font-size: 1.4rem; }
            .sentence-english { font-size: 1.35rem; }
            .timer { font-size: 1.8rem; }
            button { padding: 10px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ISW 영어 듣고 말하기</h1>
        <p class="subtitle">실전 영어회화 1000문장 | 스마트 학습 시스템</p>

        <div class="update-banner" id="updateBanner" onclick="doUpdate()">
            새 버전이 있습니다! 탭하여 업데이트
        </div>

        <div class="settings-toggle" id="settingsToggle">설정 열기/닫기</div>

        <div class="settings-grid" id="settingsGrid">
            <div class="setting-card">
                <h3>학습 모드</h3>
                <select id="modeSelector">
                    <option value="mode1">5분 x 12문장</option>
                    <option value="mode2">10분 x 6문장</option>
                    <option value="mode3">20분 x 3문장</option>
                    <option value="mode4">60분 x 1문장</option>
                </select>
                <div class="info-text" id="modeInfo">5분 x 12문장</div>
            </div>
            <div class="setting-card">
                <h3>재생 속도</h3>
                <select id="speedSelector">
                    <option value="0.5">0.5x</option>
                    <option value="0.7">0.7x</option>
                    <option value="0.8">0.8x</option>
                    <option value="1">1.0x</option>
                    <option value="1.2">1.2x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2.0x</option>
                    <option value="2.5">2.5x</option>
                    <option value="3">3.0x</option>
                </select>
                <div class="info-text" id="speedInfo">1.0x (기본)</div>
            </div>
            <div class="setting-card">
                <h3>반복 간격</h3>
                <select id="delaySelector">
                    <option value="0">즉시</option>
                    <option value="0.5">0.5초</option>
                    <option value="1">1초</option>
                    <option value="2">2초</option>
                    <option value="3">3초</option>
                    <option value="5">5초</option>
                </select>
                <div class="info-text" id="delayInfo">1초 (기본)</div>
            </div>
            <div class="setting-card">
                <h3>반복 범위</h3>
                <select id="repeatRangeSelector">
                    <option value="all">전체 음성 (7개)</option>
                    <option value="3">최근 3개 음성</option>
                    <option value="1">현재 음성만</option>
                </select>
                <div class="info-text" id="repeatRangeInfo">전체 음성 반복</div>
            </div>
        </div>

        <div class="current-sentence">
            <div class="sentence-english" id="sentenceEnglish">Press Start to Begin</div>
            <div class="sentence-pronunciation" id="sentencePronunciation">시작 버튼을 눌러주세요</div>
            <div class="sentence-korean" id="sentenceKorean">학습을 시작하세요</div>
        </div>

        <div class="info-panel">
            <div class="info-item">
                <span class="info-label">현재 섹터</span>
                <span class="info-value" id="currentSector">1 / 1</span>
            </div>
            <div class="info-item">
                <span class="info-label">섹터 내 문장</span>
                <span class="info-value" id="currentSentence">1 / 12</span>
            </div>
            <div class="info-item">
                <span class="info-label">전체 진행률</span>
                <span class="info-value" id="totalProgress">0%</span>
            </div>
            <div class="info-item">
                <span class="info-label">재생 횟수</span>
                <span class="info-value" id="playCount">0회</span>
            </div>
        </div>

        <div id="status" class="status">시작 버튼을 눌러주세요</div>

        <div class="voice-info">
            <div class="label">현재 재생 목소리</div>
            <div class="accent" id="currentAccent">미국 성인 여자</div>
            <div class="note">한 문장당 7가지 목소리 순환 재생</div>
        </div>

        <div class="timer-progress">
            <div class="timer" id="timer">5:00</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-start" id="startBtn">▶ 시작</button>
            <button class="btn-pause" id="pauseBtn" disabled>⏸ 일시정지</button>
            <button class="btn-prev" id="prevBtn">⏮ 이전</button>
            <button class="btn-next" id="nextBtn">⏭ 다음</button>
            <button class="btn-reset" id="resetBtn">초기화</button>
        </div>

        <div class="controls" style="margin-top: 10px;">
            <button class="btn-prev" id="prevSectorBtn">⏪ 이전 섹터</button>
            <button class="btn-next" id="nextSectorBtn">⏩ 다음 섹터</button>
        </div>

        <div class="version-info" id="versionInfo">v1.1.0</div>
    </div>

<script>
// ===== Config =====
const APP_VERSION = '1.1.0';
const GITHUB_REPO = 'insushim/iwlisten';
const VOICES = ['us-woman', 'us-man', 'us-girl', 'us-boy', 'uk', 'au', 'in'];
const VOICE_NAMES = {
    'us-woman': '미국 성인 여자', 'us-man': '미국 성인 남자',
    'us-girl': '미국 어린 여자', 'us-boy': '미국 어린 남자',
    'uk': '영국 영어', 'au': '호주 영어', 'in': '인도 영어'
};
const MODES = {
    mode1: { sentencesPerSector: 12, duration: 300, desc: "5분 x 12문장" },
    mode2: { sentencesPerSector: 6, duration: 600, desc: "10분 x 6문장" },
    mode3: { sentencesPerSector: 3, duration: 1200, desc: "20분 x 3문장" },
    mode4: { sentencesPerSector: 1, duration: 3600, desc: "60분 x 1문장" }
};

// ===== State =====
let allSentences = [];
let curMode = 'mode1';
let nextPlayTimer = null; // setTimeout ID for repeat delay

const S = {
    sector: 0, sentIdx: 0, voiceIdx: 0,
    playing: false, paused: false, loading: false,
    timeLeft: 300, playCount: 0,
    speed: 1, delay: 1, range: 'all',
    timer: null, wakeLock: null
};

// ===== DOM =====
const $ = id => document.getElementById(id);
const el = {
    status: $('status'), sector: $('currentSector'), sentence: $('currentSentence'),
    progress: $('totalProgress'), playCount: $('playCount'), fill: $('progressFill'),
    eng: $('sentenceEnglish'), pron: $('sentencePronunciation'), kor: $('sentenceKorean'),
    timer: $('timer'), mode: $('modeSelector'), start: $('startBtn'), pause: $('pauseBtn'),
    next: $('nextBtn'), prev: $('prevBtn'), reset: $('resetBtn'),
    prevSec: $('prevSectorBtn'), nextSec: $('nextSectorBtn'),
    accent: $('currentAccent'), banner: $('updateBanner'), ver: $('versionInfo'),
    speed: $('speedSelector'), delayEl: $('delaySelector'), rangeEl: $('repeatRangeSelector')
};

// ===== Helpers =====
function mode() { return MODES[curMode]; }
function totalSectors() { return Math.ceil(allSentences.length / mode().sentencesPerSector); }
function curSentence() {
    const i = S.sector * mode().sentencesPerSector + S.sentIdx;
    return allSentences[i % allSentences.length];
}
function showStatus(msg, type) {
    el.status.textContent = msg;
    el.status.className = 'status' + (type === 'loading' ? ' loading' : type === 'error' ? ' error' : '');
}

// ===== Settings =====
function saveSettings() {
    localStorage.setItem('isw_settings', JSON.stringify({ speed: S.speed, delay: S.delay, range: S.range }));
}
function loadSettings() {
    try { const s = JSON.parse(localStorage.getItem('isw_settings')); if (s) { S.speed = s.speed || 1; S.delay = s.delay ?? 1; S.range = s.range || 'all'; } } catch(e) {}
}
function saveProgress() {
    let all = {}; try { all = JSON.parse(localStorage.getItem('isw_prog')) || {}; } catch(e) {}
    all[curMode] = { sector: S.sector, sentIdx: S.sentIdx, playCount: S.playCount, timeLeft: S.timeLeft };
    all.lastMode = curMode;
    localStorage.setItem('isw_prog', JSON.stringify(all));
}
function loadProgress() {
    try {
        const all = JSON.parse(localStorage.getItem('isw_prog'));
        if (!all) return false;
        if (all.lastMode) { el.mode.value = all.lastMode; curMode = all.lastMode; }
        const p = all[curMode];
        if (p) { S.sector = p.sector||0; S.sentIdx = p.sentIdx||0; S.playCount = p.playCount||0; S.timeLeft = p.timeLeft ?? mode().duration; return true; }
    } catch(e) {}
    return false;
}
function loadModeProgress(m) {
    try {
        const all = JSON.parse(localStorage.getItem('isw_prog'));
        if (all && all[m]) { const p = all[m]; S.sector = p.sector||0; S.sentIdx = p.sentIdx||0; S.playCount = p.playCount||0; S.timeLeft = p.timeLeft ?? MODES[m].duration; S.voiceIdx = 0; return; }
    } catch(e) {}
    S.sector = 0; S.sentIdx = 0; S.playCount = 0; S.timeLeft = MODES[m].duration; S.voiceIdx = 0;
}

// ===== UI Update =====
function updateUI() {
    if (!allSentences.length) return;
    const s = curSentence();
    el.eng.textContent = s.english;
    el.pron.textContent = s.pronunciation;
    el.kor.textContent = s.korean;
    el.sector.textContent = `${S.sector + 1} / ${totalSectors()}`;
    el.sentence.textContent = `${S.sentIdx + 1} / ${mode().sentencesPerSector}`;
    const total = totalSectors() * mode().sentencesPerSector;
    const cur = S.sector * mode().sentencesPerSector + S.sentIdx;
    const pct = (cur / total * 100).toFixed(1);
    el.progress.textContent = pct + '%';
    el.fill.style.width = pct + '%';
    el.fill.textContent = pct + '%';
    el.playCount.textContent = S.playCount + '회';
    const min = Math.floor(S.timeLeft / 60), sec = S.timeLeft % 60;
    el.timer.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    saveProgress();
}

function syncSettingsUI() {
    el.speed.value = S.speed;
    el.delayEl.value = S.delay;
    el.rangeEl.value = S.range;
    $('speedInfo').textContent = S.speed == 1 ? '1.0x (기본)' : S.speed + 'x';
    $('delayInfo').textContent = S.delay == 0 ? '즉시' : S.delay == 1 ? '1초 (기본)' : S.delay + '초';
    const rl = { all: '전체 음성 반복 (7개)', '3': '최근 3개 음성만', '1': '현재 음성만 반복' };
    $('repeatRangeInfo').textContent = rl[S.range] || rl.all;
    $('modeInfo').textContent = mode().desc;
}

// ===== Audio Engine (HTML5 Audio - reliable cross-platform) =====
let audio = null;

function stopAudio() {
    if (nextPlayTimer) { clearTimeout(nextPlayTimer); nextPlayTimer = null; }
    if (audio) {
        audio.pause();
        audio.removeAttribute('src');
        audio.load(); // release resources
        audio = null;
    }
    // Native
    if (window.NativeAudio) try { window.NativeAudio.stop(); } catch(e) {}
}

function audioPath(sentIdx, voice) {
    return 'audio/' + String(sentIdx + 1).padStart(3, '0') + '-' + voice + '.mp3';
}

async function playNow() {
    if (S.loading || !S.playing || S.paused) return;
    S.loading = true;

    const sentence = curSentence();
    const sIdx = allSentences.indexOf(sentence);
    if (sIdx === -1) { S.loading = false; return; }

    const voice = VOICES[S.voiceIdx % VOICES.length];
    el.accent.textContent = VOICE_NAMES[voice] || voice;

    // === Native bridge (APK) ===
    if (window.NativeAudio && window.NativeAudio.isReady && window.NativeAudio.isReady()) {
        try {
            window.NativeAudio.play('public/' + audioPath(sIdx, voice));
            S.playCount++;
            updateUI();
            showStatus(`재생 중 [${S.speed}x] - ${VOICE_NAMES[voice]}`, 'normal');
            S.loading = false;
            return; // onNativeAudioComplete handles next
        } catch(e) {}
    }

    // === HTML5 Audio (web) ===
    stopAudio();
    const path = audioPath(sIdx, voice);

    try {
        audio = new Audio(path);
        audio.playbackRate = S.speed;
        audio.preservesPitch = false; // natural pitch shift at speed

        audio.onended = function() {
            S.loading = false;
            scheduleNext();
        };
        audio.onerror = function() {
            console.error('Audio error:', path);
            S.loading = false;
            // skip to next voice after brief pause
            nextPlayTimer = setTimeout(() => { if (S.playing && !S.paused) { advanceVoice(); playNow(); } }, 300);
        };

        await audio.play();
        S.playCount++;
        updateUI();
        showStatus(`재생 중 [${S.speed}x] - ${VOICE_NAMES[voice]}`, 'normal');
        S.loading = false;
    } catch(err) {
        console.error('Play failed:', err);
        S.loading = false;
        showStatus('재생 오류: ' + err.message, 'error');
    }
}

// Native callback
window.onNativeAudioComplete = function() {
    S.loading = false;
    scheduleNext();
};

function advanceVoice() {
    if (S.range === 'all') {
        S.voiceIdx = (S.voiceIdx + 1) % VOICES.length;
    } else if (S.range === '3') {
        S.voiceIdx = (S.voiceIdx + 1) % Math.min(3, VOICES.length);
    }
    // '1' = same voice
}

function scheduleNext() {
    if (!S.playing || S.paused || S.timeLeft <= 0) return;
    advanceVoice();
    const delayMs = S.delay * 1000;
    if (delayMs <= 0) {
        playNow();
    } else {
        showStatus(`다음 재생까지 ${S.delay}초...`, 'normal');
        nextPlayTimer = setTimeout(() => {
            if (S.playing && !S.paused && S.timeLeft > 0) playNow();
        }, delayMs);
    }
}

// ===== Timer =====
function startTimer() {
    if (S.timer) clearInterval(S.timer);
    S.timer = setInterval(() => {
        if (!S.paused && S.timeLeft > 0) {
            S.timeLeft--;
            updateUI();
            if (S.timeLeft === 0) nextSentence();
        }
    }, 1000);
}

// ===== Navigation =====
function goTo(sector, sentIdx) {
    stopAudio();
    S.loading = false;
    S.sector = sector;
    S.sentIdx = sentIdx;
    S.timeLeft = mode().duration;
    S.playCount = 0;
    S.voiceIdx = 0;
    updateUI();
    if (S.playing && !S.paused) playNow();
}

function nextSentence() {
    let sec = S.sector, si = S.sentIdx + 1;
    if (si >= mode().sentencesPerSector) { sec++; si = 0; }
    if (sec >= totalSectors()) { showStatus('모든 섹터 완료!', 'normal'); stop(); return; }
    goTo(sec, si);
}
function prevSentence() {
    let sec = S.sector, si = S.sentIdx - 1;
    if (si < 0) { sec--; si = mode().sentencesPerSector - 1; }
    if (sec < 0) { sec = 0; si = 0; }
    goTo(sec, si);
}
function nextSector() {
    if (S.sector + 1 >= totalSectors()) { showStatus('마지막 섹터입니다!', 'normal'); return; }
    goTo(S.sector + 1, 0);
}
function prevSector() {
    if (S.sector <= 0) { showStatus('첫 번째 섹터입니다!', 'normal'); return; }
    goTo(S.sector - 1, 0);
}

// ===== Play/Pause/Stop =====
async function start() {
    S.playing = true;
    S.paused = false;
    el.start.disabled = true;
    el.pause.disabled = false;
    el.pause.textContent = '⏸ 일시정지';
    showStatus('학습 시작!', 'normal');
    try { if ('wakeLock' in navigator) S.wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    playNow();
    startTimer();
}

function togglePause() {
    S.paused = !S.paused;
    if (S.paused) {
        el.pause.textContent = '▶ 재개';
        if (nextPlayTimer) { clearTimeout(nextPlayTimer); nextPlayTimer = null; }
        if (audio) audio.pause();
        if (window.NativeAudio) try { window.NativeAudio.pause(); } catch(e) {}
        showStatus('일시정지됨', 'normal');
        if (S.wakeLock) try { S.wakeLock.release(); S.wakeLock = null; } catch(e) {}
    } else {
        el.pause.textContent = '⏸ 일시정지';
        showStatus('학습 재개...', 'normal');
        (async()=>{ try { if ('wakeLock' in navigator) S.wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {} })();
        // Resume current audio or start fresh
        if (audio && audio.paused && audio.src) {
            audio.playbackRate = S.speed; // re-apply in case changed while paused
            audio.play().catch(() => { S.loading = false; playNow(); });
        } else if (window.NativeAudio) {
            try { window.NativeAudio.resume(); } catch(e) { S.loading = false; playNow(); }
        } else {
            S.loading = false;
            playNow();
        }
    }
}

function stop() {
    S.playing = false;
    S.paused = false;
    S.loading = false;
    stopAudio();
    if (S.timer) { clearInterval(S.timer); S.timer = null; }
    el.start.textContent = '▶ 시작';
    el.start.disabled = false;
    el.pause.disabled = true;
    el.pause.textContent = '⏸ 일시정지';
    if (S.wakeLock) try { S.wakeLock.release(); S.wakeLock = null; } catch(e) {}
}

// ===== Mode Change =====
function changeMode(newMode) {
    if (S.playing && !S.paused) {
        alert('재생 중에는 모드를 변경할 수 없습니다. 일시정지 후 변경하세요.');
        el.mode.value = curMode;
        return;
    }
    if (S.playing && S.paused) stop();
    saveProgress();
    curMode = newMode;
    loadModeProgress(newMode);
    syncSettingsUI();
    updateUI();
    showStatus(MODES[newMode].desc + ' 모드로 변경됨', 'normal');
}

// ===== Auto Update =====
let latestRelease = null;
async function checkUpdate() {
    try {
        const r = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/releases/latest', { cache: 'no-store' });
        if (!r.ok) return;
        const d = await r.json();
        const v = d.tag_name.replace(/^v/, '');
        if (v !== APP_VERSION) { latestRelease = d; el.banner.style.display = 'block'; el.banner.textContent = 'v' + v + ' 업데이트 가능! 탭하여 다운로드'; }
    } catch(e) {}
}
function doUpdate() {
    if (!latestRelease) return;
    const apk = latestRelease.assets && latestRelease.assets.find(a => a.name.endsWith('.apk'));
    window.open(apk ? apk.browser_download_url : latestRelease.html_url, '_system');
}

// ===== Event Listeners =====
el.start.onclick = start;
el.pause.onclick = togglePause;
el.next.onclick = nextSentence;
el.prev.onclick = prevSentence;
el.nextSec.onclick = nextSector;
el.prevSec.onclick = prevSector;
el.reset.onclick = () => { if (confirm('처음부터 다시 시작하시겠습니까?')) { stop(); goTo(0, 0); showStatus('처음으로 돌아갔습니다', 'normal'); } };
el.mode.onchange = (e) => changeMode(e.target.value);

el.speed.onchange = (e) => {
    S.speed = parseFloat(e.target.value);
    if (audio && !audio.paused) audio.playbackRate = S.speed;
    $('speedInfo').textContent = S.speed == 1 ? '1.0x (기본)' : S.speed + 'x';
    saveSettings();
};
el.delayEl.onchange = (e) => {
    S.delay = parseFloat(e.target.value);
    $('delayInfo').textContent = S.delay == 0 ? '즉시' : S.delay == 1 ? '1초 (기본)' : S.delay + '초';
    saveSettings();
};
el.rangeEl.onchange = (e) => {
    S.range = e.target.value;
    S.voiceIdx = 0;
    const rl = { all: '전체 음성 반복 (7개)', '3': '최근 3개 음성만', '1': '현재 음성만 반복' };
    $('repeatRangeInfo').textContent = rl[S.range];
    saveSettings();
};
$('settingsToggle').onclick = () => $('settingsGrid').classList.toggle('show');

// Re-acquire wake lock on visibility change
document.addEventListener('visibilitychange', () => {
    if (S.playing && !S.paused && document.visibilityState === 'visible') {
        (async()=>{ try { if ('wakeLock' in navigator) S.wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {} })();
    }
});

// ===== Init =====
async function init() {
    el.ver.textContent = 'v' + APP_VERSION;
    loadSettings();
    syncSettingsUI();

    try {
        const r = await fetch('sentences.json');
        allSentences = await r.json();
    } catch(e) { showStatus('문장 데이터 로딩 실패', 'error'); return; }

    // NativeAudio init (Android)
    for (let i = 0; i < 20 && !window.NativeAudio; i++) await new Promise(r => setTimeout(r, 100));
    if (window.NativeAudio) {
        for (let i = 0; i < 30; i++) { try { if (window.NativeAudio.isReady()) { showStatus('백그라운드 재생 준비 완료!', 'normal'); break; } } catch(e) {} await new Promise(r => setTimeout(r, 100)); }
    }

    if (loadProgress()) showStatus('이전 학습 위치를 불러왔습니다!', 'normal');
    syncSettingsUI();
    updateUI();
    checkUpdate();
}
init();
</script>
</body>
</html>
